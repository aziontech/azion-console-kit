<template>
  <div class="flex flex-col min-h-[calc(100vh-300px)]">
    <form
      @submit.prevent="handleSubmit"
      class="w-full grow flex flex-col gap-8 max-md:gap-6"
    >
      <slot name="form" />

      <slot name="raw-form" />
    </form>
  </div>

  <DialogUnsavedBlock
    :leavePage="leavePage"
    :blockRedirectUnsaved="hasModifications"
  />
  <Teleport
    to="#action-bar"
    v-if="teleportLoad"
  >
    <ActionBarTemplate
      @cancel="handleCancel"
      @submit="handleSubmit"
      :loading="isLoading"
      :submitDisabled="!formMeta.valid"
    />
  </Teleport>
</template>

<script>
  import DialogUnsavedBlock from '@/templates/dialog-unsaved-block'
  import ActionBarTemplate from '@/templates/action-bar-block'

  export default {
    name: 'edit-form-block',
    components: {
      ActionBarTemplate,
      DialogUnsavedBlock
    },
    data: () => ({
      isLoading: false,
      blockViewRedirection: true,
      teleportLoad: false
    }),
    props: {
      editService: {
        type: Function,
        required: true
      },
      loadService: {
        type: Function,
        required: true
      },
      initialDataSetter: {
        type: Function,
        required: true
      },
      formData: {
        type: Object,
        required: true
      },
      backURL: {
        type: String,
        required: false
      },
      hasTabs: {
        type: Boolean,
        required: false
      },
      formMeta: {
        type: Object,
        required: true
      },
      updatedRedirect: {
        type: String,
        required: true
      }
    },
    async created() {
      await this.loadInitialData()
    },
    mounted() {
      this.teleportLoad = true
    },
    methods: {
      leavePage(dialogUnsaved) {
        dialogUnsaved = false
        this.handleCancel()
        return dialogUnsaved
      },
      goBackToList() {
        if (this.updatedRedirect) {
          this.$router.push({ name: this.updatedRedirect })
          return
        }
        this.$router.go(-1)
      },
      handleCancel() {
        if (this.backURL) {
          this.$router.push({ path: this.backURL })
        } else {
          this.goBackToList()
        }
      },
      async loadInitialData() {
        try {
          const { id } = this.$route.params
          this.isLoading = true
          const initialData = await this.loadService({ id })
          this.initialDataSetter(initialData)
        } catch (error) {
          this.$toast.add({
            closable: false,
            severity: 'error',
            summary: error,
            life: 10000
          })
        } finally {
          this.isLoading = false
        }
      },
      async handleSubmit() {
        try {
          this.isLoading = true
          const feedback = await this.editService(this.formData)
          this.$toast.add({
            closable: false,
            severity: 'success',
            summary: feedback ?? 'edited successfully',
            life: 10000
          })
          this.blockViewRedirection = false
          this.goBackToList()
        } catch (error) {
          this.blockViewRedirection = true
          this.$toast.add({
            closable: false,
            severity: 'error',
            summary: error,
            life: 10000
          })
        } finally {
          setTimeout(() => {
            this.isLoading = false
          }, 800)
        }
      }
    },
    computed: {
      hasModifications() {
        return this.formMeta.touched && this.blockViewRedirection
      }
    }
  }
</script>
