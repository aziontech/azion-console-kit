<template>
  <div>
    <section
      class="w-full max-w-screen-2xl md:mx-auto flex flex-col gap-6 lg:gap-8 px-3 pt-4 pb-8 md:px-8 md:pt-8"
    >
      <!-- Getting Started -->
      <div
        class="w-full p-3 sm:p-8 surface-border border rounded-md flex flex-col gap-6 lg:gap-10 justify-between"
      >
        <div class="flex flex-col gap-4 max-w-4xl">
          <h1 class="text-color text-2xl md:text-3xl font-medium">Get Started</h1>
          <h2 class="text-sm md:text-xl text-color-secondary font-normal">
            Great to have you on board! Fell free to explore, or get a head start below.
          </h2>
        </div>
        <div>
          <PrimeButton
            class="w-full sm:w-auto"
            label="Create something new"
            type="button"
            size="small"
            @click="createBoardManager.open()"
          />
        </div>
      </div>

      <div class="flex flex-col xl:flex-row gap-6">
        <!-- Manage Applications -->
        <div class="w-full p-3 sm:p-6 flex flex-col gap-6 surface-border border rounded-md">
          <div class="flex flex-row justify-start gap-3">
            <div
              class="w-11 h-11 flex flex-shrink-0 justify-center items-center rounded-md surface-200"
            >
              <span class="pi pi-box"></span>
            </div>
            <div class="flex flex-col gap-2">
              <div class="text-lg sm:text-xl font-medium">Manage your applications</div>
              <div class="text-xs sm:text-sm text-color-secondary">
                Add and manage custom domains to your edge applications.
              </div>
            </div>
          </div>
          <div class="flex flex-col items-start sm:flex-row gap-3 sm:gap-4">
            <PrimeButton
              type="button"
              label="Manage Applications"
              outlined
              class="w-full sm:w-auto"
              size="small"
              @click="navigateToEdgeApplications"
            />
            <PrimeButton
              type="button"
              label="Learn how to edit an application"
              link
              class="w-full sm:w-auto"
              icon="pi pi-external-link"
              iconPos="right"
              size="small"
              @click="openDocsEdgeApplication"
              :pt="{
                root: { class: 'justify-center' },
                label: { class: 'grow-0' }
              }"
            />
          </div>
        </div>
        <!-- View Analytics -->
        <div class="w-full p-3 sm:p-6 flex flex-col gap-6 surface-border border rounded-md">
          <div class="flex flex-row justify-start gap-3">
            <div
              class="w-11 h-11 flex flex-shrink-0 justify-center items-center rounded-md surface-200"
            >
              <span class="pi pi-chart-line"></span>
            </div>
            <div class="flex flex-col gap-2">
              <div class="text-lg sm:text-xl font-medium">View analytics</div>
              <div class="text-xs sm:text-sm text-color-secondary">
                Gain powerful insights into your performance, availability, and security.
              </div>
            </div>
          </div>
          <div class="flex flex-col items-start sm:flex-row gap-3 sm:gap-4">
            <PrimeButton
              type="button"
              class="sm:w-auto w-full"
              label="View Real-Time Metrics"
              outlined
              size="small"
              @click="navigateToRealTimeMetrics"
            />
            <PrimeButton
              type="button"
              label="About Real-Time Metrics"
              link
              class="w-full sm:w-auto"
              icon="pi pi-external-link"
              iconPos="right"
              size="small"
              @click="openDocsRealTimeMetrics"
              :pt="{
                root: { class: 'justify-center' },
                label: { class: 'grow-0' }
              }"
            />
          </div>
        </div>
      </div>

      <div
        class="w-full p-3 sm:p-6 surface-border border rounded-md flex flex-col gap-6 justify-between relative"
        v-if="showInviteSession"
      >
        <PrimeButton
          icon="pi pi-times"
          outlined
          class="absolute right-3 top-3 sm:right-6 sm:top-6"
          size="small"
          type="button"
          @click="closeInviteSession"
        />
        <div class="flex flex-col gap-2">
          <div class="text-lg sm:text-xl font-medium">Invite your team</div>
          <div class="text-xs sm:text-sm text-color-secondary">
            All Azion plans include unlimited seats for your team. Invite your colleagues to start
            building with you.
          </div>
        </div>
        <form
          class="flex flex-col lg:flex-row justify-between gap-3 sm:gap-6"
          @submit.prevent="handleSubmit"
        >
          <!-- Input Name -->
          <div class="flex flex-col w-full gap-2">
            <label
              for="name"
              class="text-color text-sm font-medium"
              >Name</label
            >
            <InputText
              v-model="name"
              id="name"
              type="text"
              :class="{ 'p-invalid': errors.name }"
            />
            <small
              v-if="errors.name"
              class="p-error text-xs font-normal leading-tight"
              >{{ errors.name }}</small
            >
          </div>

          <!-- Input Email -->
          <div class="flex flex-col w-full gap-2">
            <label
              for="email"
              class="text-color text-sm font-medium"
              >E-mail</label
            >
            <InputText
              v-model="email"
              id="email"
              type="text"
              :class="{ 'p-invalid': errors.email }"
            />
            <small
              v-if="errors.email"
              class="p-error text-xs font-normal leading-tight"
              >{{ errors.email }}</small
            >
          </div>

          <!-- Input Team -->
          <div class="flex flex-col w-full gap-2">
            <label
              for="team"
              class="text-color text-sm font-medium"
              >Team</label
            >
            <Dropdown
              id="team"
              :class="{ 'p-invalid': errors.team }"
              v-model="team"
              :options="teams"
              optionLabel="label"
              optionValue="value"
              class="w-full"
              placeholder="Choose a team"
            />
            <small
              v-if="errors.team"
              class="p-error text-xs font-normal leading-tight"
              >{{ errors.team }}</small
            >
          </div>

          <div class="mt-auto lg:mt-7">
            <PrimeButton
              severity="secondary"
              type="submit"
              label="Invite"
              size="small"
              :disabled="isDisabled"
              class="w-full px-4 lg:w-auto"
            />
          </div>
        </form>
      </div>

      <div class="w-full flex flex-col lg:flex-row gap-6 justify-between">
        <!-- Product -->
        <button
          type="button"
          class="sm:h-auto lg:h-40 hover:border-primary transition-all w-full p-3 sm:p-6 text-start flex flex-col gap-2 surface-border border rounded-md"
          @click="openProductDocumentation"
        >
          <div class="text-lg font-medium">Product Documentation</div>
          <div class="text-sm text-color-secondary">
            Detailed documentation on each of our products and their features.
          </div>
        </button>
        <!-- API -->
        <button
          type="button"
          class="sm:h-auto lg:h-40 hover:border-primary transition-all w-full p-3 sm:p-6 text-start flex flex-col gap-2 surface-border border rounded-md"
          @click="openAPIDocumentation"
        >
          <div class="text-lg font-medium">API Documentation</div>
          <div class="text-sm text-color-secondary">
            Azion's API exposes the entire Azion product portfolio via a standardized programmatic
            interface.
          </div>
        </button>
        <!-- Contact -->
        <button
          type="button"
          class="sm:h-auto lg:h-40 hover:border-primary transition-all w-full p-3 sm:p-6 text-start flex flex-col gap-2 surface-border border rounded-md"
          @click="openContactSupport"
        >
          <div class="text-lg font-medium">Contact Support</div>
          <div class="text-sm text-color-secondary">
            Send queries, suggestions or report to our specialized support team.
          </div>
        </button>
      </div>
    </section>
  </div>
</template>

<script>
  import PrimeButton from 'primevue/button'
  import InputText from 'primevue/inputtext'
  import Dropdown from 'primevue/dropdown'
  import { useField, useForm } from 'vee-validate'
  import * as yup from 'yup'

  export default {
    name: 'home-view',
    components: {
      PrimeButton,
      InputText,
      Dropdown
    },
    inject: ['createBoardManager'],
    props: {
      listTeamsService: {
        type: Function,
        required: true
      },
      inviteYourTeamService: {
        type: Function,
        required: true
      },
      inviteSession: {
        type: Function,
        required: true
      },
      windowManager: {
        type: Object,
        required: true
      }
    },
    data() {
      return {
        teams: [],
        isLoading: false,
        showInviteSession: this.inviteSession.show()
      }
    },
    async created() {
      this.teams = await this.listTeamsService()

      if (this.inviteSession.sessionIsExpired()) {
        this.inviteSession.turnInviteBlockVisable()
      }
    },
    computed: {
      isDisabled() {
        return !this.meta?.valid || this.isLoading
      }
    },
    methods: {
      navigateToEdgeApplications() {
        this.$router.push({ name: 'list-edge-applications' })
      },
      navigateToRealTimeMetrics() {},
      openDocsEdgeApplication() {
        this.windowManager.documentationGuideProducts.edgeApplication()
      },
      openDocsRealTimeMetrics() {
        this.windowManager.documentationGuideProducts.realTimeMetrics()
      },
      openProductDocumentation() {
        this.windowManager.openDocumentation()
      },
      openAPIDocumentation() {
        this.windowManager.openAPIDocumentation()
      },
      openContactSupport() {
        this.windowManager.openContactSupport()
      },
      async handleSubmit() {
        try {
          this.isLoading = true
          const feedback = await this.inviteYourTeamService(this.values)
          this.handleSuccess(feedback)
        } catch (error) {
          this.showToast('error', error)
        } finally {
          this.isLoading = false
        }
      },
      handleSuccess(feedback) {
        this.resetForm()
        this.showToast('success', feedback)
      },
      showToast(severity, summary, life = 10000) {
        this.$toast.add({
          closable: false,
          severity: severity,
          summary: summary,
          life: life
        })
      },
      closeInviteSession() {
        this.inviteSession.closeInviteBlock()
        this.showInviteSession = false
      }
    },
    setup() {
      const validationSchema = yup.object({
        name: yup.string().required('Name is a required field'),
        email: yup.string().email('Must be a valid email').required('E-mail is a required field'),
        team: yup.string().required()
      })

      const { errors, meta, resetForm, values } = useForm({
        validationSchema,
        initialValues: {}
      })

      const { value: name } = useField('name')
      const { value: email } = useField('email')
      const { value: team } = useField('team')

      return {
        name,
        email,
        team,
        validationSchema,
        errors,
        meta,
        resetForm,
        values
      }
    }
  }
</script>
